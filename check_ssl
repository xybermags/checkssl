#!/bin/bash

THRESHOLD_DAYS=45
ADMIN="admin@example.com"

DOMAINS=(
  "example.com"
  "expired.badssl.com"
)

echo "Starting SSL certificate check..."
echo "----------------------------------------------"

for domain in "${DOMAINS[@]}"; do
    echo "Checking $domain ..."

    expiry_date=$(echo | openssl s_client -servername "$domain" -connect "$domain:443" 2>/dev/null                    | openssl x509 -noout -enddate | cut -d= -f2)

    if [ -z "$expiry_date" ]; then
        echo "  ERROR: Could not retrieve SSL certificate for $domain"
        continue
    fi

    expiry_epoch=$(date -d "$expiry_date" +%s)
    now_epoch=$(date +%s)

    days_left=$(((expiry_epoch - now_epoch) / 86400))

    if [ "$days_left" -le "$THRESHOLD_DAYS" ]; then
        msg="SSL certificate for $domain expires in $days_left days (on $expiry_date)."
        echo "  ALERT: $msg"
        # echo "$msg" | mail -s "SSL Expiry Alert: $domain" "$ADMIN"
    else
        echo "  OK: $domain valid for $days_left more days (until $expiry_date)"
    fi

    echo
done

echo "SSL certificate check complete."
echo "----------------------------------------------"
